<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> åŒæƒé‡ç¨åˆ¶ï¼šå„æ–­ç¨ Ã— ä½æ•ˆç¨ </title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #0f1620;
      --card2: #0c121a;
      --line: #1f2a37;
      --text: #e5e7eb;
      --muted: #9aa4b2;
      --bar: #0f1620ee;
      --shadow: 0 10px 26px rgba(0, 0, 0, .45);
      --radius: 12px;
      --focus: #7aa2ff;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      width: 100%;
      height: 100%
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      /* left pane scrolls */
    }

    header {
      padding: 10px 14px 6px;
      border-bottom: 1px solid var(--line);
      background: var(--card);
    }

    h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 700;
      color: var(--text)
    }

    /* main split: left=60% (scroll), right=40% (sticky) */
    #main {
      display: flex;
      height: calc(100vh - 48px);
      max-width: 100vw;
      margin: 0 auto;
    }

    #left {
      flex: 0 0 60%;
      min-width: 0;
      overflow-y: auto;
      padding: 12px 12px 110px;
    }

    #right {
      flex: 0 0 40%;
      min-width: 0;
      padding: 12px 12px 110px;
    }

    @media (max-width:1100px) {
      body {
        overflow: auto;
        height: auto
      }

      #main {
        flex-direction: column;
        height: auto
      }

      #left,
      #right {
        flex: 1 1 auto;
        padding-bottom: 140px;
        overflow: visible
      }

      #right {
        padding-top: 0
      }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 1px 0 rgba(0, 0, 0, .20);
    }

    /* left grid: 2 per row for plots 1-6 */
    #grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width:1100px) {
      #grid {
        grid-template-columns: 1fr
      }
    }

    .plot-card {
      padding: 10px 10px 8px
    }

    .plot-card h2 {
      margin: 0 0 8px;
      font-size: 13px;
      font-weight: 650;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--text);
    }

    .plot {
      width: 100%;
      height: 400px
    }

    @media (max-width:1100px) {
      .plot {
        height: 360px
      }
    }

    /* plot 7 right pane */
    #p7wrap {
      position: sticky;
      top: 10px;
      padding: 10px 10px 8px;
      height: calc(100vh - 48px - 20px - 110px);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    @media (max-width:1100px) {
      #p7wrap {
        position: static;
        height: auto
      }
    }

    #p7 {
      flex: 1 1 auto;
      min-height: 520px
    }

    /* per-plot explanation tooltip under plot (shows on hover/focus) */
    .sym {
      position: relative;
      margin-top: 6px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      flex-wrap: wrap;
    }

    .sym .trigger {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12.5px;
      color: var(--muted);
      cursor: help;
      user-select: none;
      outline: none;
    }

    .sym:focus-within .trigger {
      color: var(--text)
    }

    .sym .trigger .dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid var(--line);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      line-height: 1;
      background: var(--card2);
      color: var(--muted);
    }

    .sym .tip {
      position: absolute;
      left: 0;
      bottom: 26px;
      min-width: min(720px, calc(100vw - 40px));
      max-width: 900px;
      padding: 10px 12px;
      background: #111827;
      /* slightly lighter than pure black */
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, .06);
      border-radius: 10px;
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(6px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease;
      font-size: 12.5px;
      line-height: 1.5;
      z-index: 10;
      white-space: pre-wrap;
    }

    .sym:hover .tip,
    .sym:focus-within .tip {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .sym .tip code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #dbeafe;
    }

    /* fixed controls bar at bottom (bigger) */
    #controlsBar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bar);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
      box-shadow: var(--shadow);
      z-index: 999;
    }

    #controlsInner {
      max-width: none;
      /* è®©å®ƒåˆ«è¢« 1920 é™åˆ¶ */
      margin: 0;
      padding: 16px 18px;
      /* å˜åš */
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      /* ç»„é—´è·å˜å¤§ */
      flex-wrap: wrap;
    }

    .ctrlGroup {
      display: flex;
      align-items: center;
      gap: 14px;
      /* ç»„å†…è·å˜å¤§ */
      flex-wrap: wrap;
    }

    label {
      display: inline-flex;
      align-items: center;
      gap: 14px;
      font-size: 20px;
      /* å˜å¤§ */
      color: var(--muted);
    }

    select,
    button {
      padding: 12px 16px;
      /* æ§ä»¶å˜å¤§ */
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      font-size: 20px;
    }

    input[type=range] {
      width: min(720px, 50vw);
      /* æ»‘æ¡æ›´é•¿ */
      height: 28px;
      /* æå‡å¯ç‚¹æ€§ï¼ˆéƒ¨åˆ†æµè§ˆå™¨æœ‰æ•ˆï¼‰ */
      accent-color: var(--focus);
    }

    input[type=number],
    input[type=text] {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      font-size: 20px;
      width: 180px;
    }

    input::placeholder {
      color: var(--muted);
    }


    #betaVal {
      font-variant-numeric: tabular-nums;
      min-width: 74px;
      font-size: 20px;
      text-align: right;
      color: var(--text);
    }


    /* Plotly modebar (icons) */
    .modebar {
      background: transparent !important
    }

    .modebar-btn {
      background: transparent !important
    }

    .modebar-btn path {
      fill: var(--muted) !important
    }

    .modebar-btn:hover path {
      fill: var(--text) !important
    }
  </style>

</head>

<body>
  <header>
    <h1> åŒæƒé‡ç¨åˆ¶ï¼šå„æ–­ç¨ Ã— ä½æ•ˆç¨ </h1>
  </header>

  <div id="main">
    <!-- Left: plots 1-6 in 2-per-row grid (scrollable) -->
    <div id="left">
      <div id="grid">
        <section class="card plot-card">
          <h2><span>1. è¡Œä¸šäº§å€¼å›¾</span></h2>
          <div id="p1" class="plot"></div>
          <div class="sym" tabindex="0">
            <span class="trigger"><span class="dot">i</span>æŒ‡æ ‡è¯´æ˜ï¼ˆæ‚¬æµ®æŸ¥çœ‹ï¼‰</span>
            <div class="tip">
              è¿™å¼ å›¾å±•ç¤ºæ¯ä¸ªâ€œè¡Œä¸šä¸»ä½“â€çš„ã€äº§å€¼ã€‘ã€‚
              - æ¨ªè½´ï¼šä¸»ä½“ç¼–å·ï¼ˆ0~N-1ï¼‰ï¼Œä»…ç”¨äºåŒºåˆ†ä¸åŒä¸»ä½“
              - çºµè½´ï¼šäº§å€¼ï¼ˆéšæœºç”Ÿæˆï¼‰
              - äº§å€¼è¶Šå¤§ï¼Œè¡¨ç¤ºè¯¥ä¸»ä½“å¯¹è¡Œä¸šæ€»äº§å‡ºçš„è´¡çŒ®è¶Šå¤§

              ç¬¦å·å¯¹ç…§ï¼š
              - äº§å€¼ = V_i
              - ä¸»ä½“æ•° = Nï¼ˆæœ¬é¡µå›ºå®š N=512ï¼‰
            </div>
          </div>
        </section>

        <section class="card plot-card">
          <h2><span>2. è¡Œä¸šä¸»ä½“é›‡ä½£äººæ•°å›¾</span></h2>
          <div id="p2" class="plot"></div>
          <div class="sym" tabindex="0">
            <span class="trigger"><span class="dot">i</span>æŒ‡æ ‡è¯´æ˜ï¼ˆæ‚¬æµ®æŸ¥çœ‹ï¼‰</span>
            <div class="tip">
              è¿™å¼ å›¾å±•ç¤ºæ¯ä¸ªâ€œè¡Œä¸šä¸»ä½“â€çš„ã€é›‡ä½£äººæ•°ã€‘ã€‚
              - æ¨ªè½´ï¼šä¸»ä½“ç¼–å·ï¼ˆ0~N-1ï¼‰
              - çºµè½´ï¼šé›‡ä½£äººæ•°ï¼ˆéšæœºç”Ÿæˆã€å–æ•´ä¸” â‰¥ 1ï¼‰
              - é›‡ä½£äººæ•°ç”¨äºè®¡ç®—â€œäººå‡äº§å€¼â€ï¼Œä»è€Œå¾—åˆ°â€œä½æ•ˆç¨‹åº¦â€

              ç¬¦å·å¯¹ç…§ï¼š
              - é›‡ä½£äººæ•° = L_i
              - EPSï¼šæ•°å€¼ç¨³å®šç”¨çš„å°é‡ï¼ˆé¿å…é™¤é›¶ï¼‰
            </div>
          </div>
        </section>

        <section class="card plot-card">
          <h2><span>3. å„æ–­æ¯”ä¾‹å›¾</span></h2>
          <div id="p3" class="plot"></div>
          <div class="sym" tabindex="0">
            <span class="trigger"><span class="dot">i</span>æŒ‡æ ‡è¯´æ˜ï¼ˆæ‚¬æµ®æŸ¥çœ‹ï¼‰</span>
            <div class="tip">
              è¿™å¼ å›¾æŠŠâ€œå„æ–­ç¨‹åº¦â€å®šä¹‰ä¸ºã€ç›¸å¯¹å¹³å‡äº§å€¼çš„å€æ•°ã€‘ã€‚
              - å…ˆç®—å¹³å‡äº§å€¼ï¼šå¹³å‡äº§å€¼ = Î¼ = (âˆ‘äº§å€¼)/N
              - å†ç®—å„æ–­ç¨‹åº¦ï¼šå„æ–­ç¨‹åº¦ = Ï_i = äº§å€¼ / å¹³å‡äº§å€¼

              è¯»å›¾æ–¹å¼ï¼š
              - y=1 çš„è™šçº¿ï¼šåˆšå¥½ç­‰äºå¹³å‡æ°´å¹³
              - Ï_i > 1ï¼šè¯¥ä¸»ä½“äº§å€¼é«˜äºå¹³å‡ï¼ˆæ›´â€œé›†ä¸­/åå„æ–­â€ï¼‰
              - Ï_i < 1ï¼šè¯¥ä¸»ä½“äº§å€¼ä½äºå¹³å‡ - æ¨ªè½´ kï¼šæŒ‰äº§å€¼ä»å°åˆ°å¤§æ’åºåçš„åæ¬¡ï¼ˆä¾¿äºçœ‹åˆ†å¸ƒå½¢çŠ¶ï¼‰ ç¬¦å·å¯¹ç…§ï¼š - å¹³å‡äº§å€¼=Î¼ - å„æ–­ç¨‹åº¦=Ï_i - æ’åºç´¢å¼•=k=argsort(äº§å€¼) </div>
            </div>
        </section>

        <section class="card plot-card">
          <h2><span>4. ä½æ•ˆæ¯”ä¾‹å›¾</span></h2>
          <div id="p4" class="plot"></div>
          <div class="sym" tabindex="0">
            <span class="trigger"><span class="dot">i</span>æŒ‡æ ‡è¯´æ˜ï¼ˆæ‚¬æµ®æŸ¥çœ‹ï¼‰</span>
            <div class="tip">
              è¿™å¼ å›¾æŠŠâ€œä½æ•ˆç¨‹åº¦â€å®šä¹‰ä¸ºã€ç›¸å¯¹å¹³å‡äººå‡äº§å€¼çš„â€œåæ¯”å€æ•°â€ã€‘ã€è¶Šå¤§è¶Šä½æ•ˆã€‘ã€‚
              - å…ˆç®—äººå‡äº§å€¼ï¼šäººå‡äº§å€¼ = a_i = äº§å€¼ / é›‡ä½£äººæ•°
              - å†ç®—å¹³å‡äººå‡äº§å€¼ï¼šå¹³å‡äººå‡äº§å€¼ = Ä = (âˆ‘a_i)/N
              - å†å®šä¹‰ä½æ•ˆç¨‹åº¦ï¼šä½æ•ˆç¨‹åº¦ = Îº_i = å¹³å‡äººå‡äº§å€¼ / äººå‡äº§å€¼

              è¯»å›¾æ–¹å¼ï¼š
              - y=1 çš„è™šçº¿ï¼šåˆšå¥½ç­‰äºå¹³å‡æ•ˆç‡
              - Îº_i > 1ï¼šäººå‡äº§å€¼ä½äºå¹³å‡ â‡’ æ›´ä½æ•ˆ
              - Îº_i < 1ï¼šäººå‡äº§å€¼é«˜äºå¹³å‡ â‡’ æ›´é«˜æ•ˆ - æ¨ªè½´ kï¼šæŒ‰äººå‡äº§å€¼ä»å°åˆ°å¤§æ’åºåçš„åæ¬¡ ç¬¦å·å¯¹ç…§ï¼š - äººå‡äº§å€¼=a_i - å¹³å‡äººå‡äº§å€¼=Ä - ä½æ•ˆç¨‹åº¦=Îº_i </div>
            </div>
        </section>

        <section class="card plot-card">
          <h2><span>5. å„æ–­ç¨æƒé‡</span></h2>
          <div id="p5" class="plot"></div>
          <div class="sym" tabindex="0">
            <span class="trigger"><span class="dot">i</span>æŒ‡æ ‡è¯´æ˜ï¼ˆæ‚¬æµ®æŸ¥çœ‹ï¼‰</span>
            <div class="tip">
              è¿™å¼ å›¾æŠŠâ€œå„æ–­ç¨‹åº¦â€è½¬æˆã€å„æ–­ç¨åˆ†é…æƒé‡ã€‘ï¼ˆæ‰€æœ‰ä¸»ä½“æƒé‡åŠ å’Œä¸º 1ï¼‰ã€‚
              - è¾“å…¥ï¼šå„æ–­ç¨‹åº¦ Ï_i
              - è°ƒèŠ‚å¼ºåº¦ï¼šÎ²ï¼ˆæ»‘æ¡ 0~2ï¼‰
              - è®¡ç®—ï¼šu_i = Î² Â· Ï_i
              - å† softmax å¾—åˆ°ï¼šå„æ–­ç¨æƒé‡ = w^M_i = softmax(u)_i

              è¯»å›¾æ–¹å¼ï¼š
              - Î² è¶Šå¤§ï¼šæƒé‡è¶Šå‘â€œå„æ–­æ›´å¼ºï¼ˆÏæ›´å¤§ï¼‰â€çš„ä¸»ä½“é›†ä¸­
              - Î² è¶Šå°ï¼šæ›´æ¥è¿‘å¹³å‡åˆ†é…

              è½¯æœ€å¤§ï¼ˆç¨³å®šå†™æ³•ï¼‰ï¼š
              m = max(u)
              w_i = exp(u_i - m) / (âˆ‘exp(u_k - m) + EPS)

              å›¾ä¸­æ¨ªè½´ä»æŒ‰ã€äº§å€¼ã€‘ä»å°åˆ°å¤§æ’åºï¼ˆä¸å›¾3å¯¹é½ï¼‰
            </div>
          </div>
        </section>

        <section class="card plot-card">
          <h2><span>6. ä½æ•ˆç¨æƒé‡</span></h2>
          <div id="p6" class="plot"></div>
          <div class="sym" tabindex="0">
            <span class="trigger"><span class="dot">i</span>æŒ‡æ ‡è¯´æ˜ï¼ˆæ‚¬æµ®æŸ¥çœ‹ï¼‰</span>
            <div class="tip">
              è¿™å¼ å›¾æŠŠâ€œä½æ•ˆç¨‹åº¦â€è½¬æˆã€ä½æ•ˆç¨åˆ†é…æƒé‡ã€‘ï¼ˆæ‰€æœ‰ä¸»ä½“æƒé‡åŠ å’Œä¸º 1ï¼‰ã€‚
              - è¾“å…¥ï¼šä½æ•ˆç¨‹åº¦ Îº_i
              - è°ƒèŠ‚å¼ºåº¦ï¼šÎ²áµƒ = (2 - Î²) ï¼ˆä¸ä½ è®¾å®šä¸€è‡´ï¼šå„æ–­ä¾§ç”¨ Î²ï¼ŒAGI ä¾§ç”¨ 2-Î²ï¼‰
              - è®¡ç®—ï¼šu_i = Î²áµƒ Â· (Îº_i - 1)
              - å† softmax å¾—åˆ°ï¼šä½æ•ˆç¨æƒé‡ = w^A_i = softmax(u)_i

              è¯»å›¾æ–¹å¼ï¼š
              - (2-Î²) è¶Šå¤§ï¼šæƒé‡è¶Šå‘â€œæ›´ä½æ•ˆï¼ˆÎºæ›´å¤§ï¼‰â€çš„ä¸»ä½“é›†ä¸­
              - (2-Î²) è¶Šå°ï¼šæ›´æ¥è¿‘å¹³å‡åˆ†é…

              å›¾ä¸­æ¨ªè½´æŒ‰ã€äººå‡äº§å€¼ã€‘ä»å°åˆ°å¤§æ’åºï¼ˆä¸å›¾4å¯¹é½ï¼‰
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Right: plot 7 follows view -->
    <div id="right">
      <section id="p7wrap" class="card">
        <h2
          style="margin:0;font-size:13px;font-weight:650;display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;">
          <span>7. ç»¼åˆç¨ç‡ä¸‰ç»´è§†è§’</span>
        </h2>
        <div id="p7"></div>
        <div class="sym" tabindex="0">
          <span class="trigger"><span class="dot">i</span>æŒ‡æ ‡è¯´æ˜ï¼ˆæ‚¬æµ®æŸ¥çœ‹ï¼‰</span>
          <div class="tip">
            ä¸‰ç»´å›¾æŠŠæ¯ä¸ªä¸»ä½“æ˜ å°„åˆ°ä¸€ä¸ªç‚¹ï¼š
            - xï¼šå„æ–­ç¨‹åº¦ï¼ˆÏ_iï¼‰= äº§å€¼ / å¹³å‡äº§å€¼
            - yï¼šä½æ•ˆç¨‹åº¦ï¼ˆÎº_iï¼‰= å¹³å‡äººå‡äº§å€¼ / äººå‡äº§å€¼
            - zï¼šç»¼åˆç¨ç‡ï¼ˆt_iï¼‰= è¯¥ä¸»ä½“æœ€ç»ˆåº”æ‰¿æ‹…çš„â€œç»¼åˆç¨åˆ†é…æ¯”ä¾‹â€

            ç»¼åˆç¨ç‡å¦‚ä½•å¾—åˆ°ï¼š
            1) å…ˆå¾—åˆ°ä¸¤å¥—â€œåˆ†é…æƒé‡â€ï¼ˆå„è‡ªåŠ å’Œä¸º1ï¼‰
            - å„æ–­ç¨æƒé‡ï¼šw^M_i = softmax(Î² Â· Ï_i)
            - ä½æ•ˆç¨æƒé‡ï¼šw^A_i = softmax((2-Î²) Â· (Îº_i - 1))

            2) æŠŠä¸¤éƒ¨åˆ†ç¨â€œç›¸åŠ â€åï¼Œå†å¯¹å…¨ä½“ä¸»ä½“åšä¸€æ¬¡å½’ä¸€åŒ–ï¼š
            raw_i = w^M_i + w^A_i
            t_i = raw_i / (âˆ‘raw + EPS)

            å› æ­¤ï¼š
            - z è½´ t_i çš„æ€»å’Œå›ºå®šä¸º 1
            - æŸä¸ªç‚¹è¶Šâ€œé«˜â€ï¼Œè¡¨ç¤ºè¯¥ä¸»ä½“åœ¨ç»¼åˆç¨ä¸­å æ¯”è¶Šå¤§
          </div>
        </div>
    </div>
    </section>
  </div>
  </div>

  <div id="controlsBar">
    <div id="controlsInner">
      <div class="ctrlGroup">
        <label>
          <span>éšæœºåˆ†å¸ƒ</span>
          <select id="dist">
            <option value="uniform">å‡åŒ€åˆ†å¸ƒ</option>
            <option value="normal">æ­£æ€åˆ†å¸ƒ</option>
            <option value="powerlaw">å¹‚å¾‹åˆ†å¸ƒ</option>
          </select>
        </label>
        <button id="randBtn">ğŸ² éšæœºåˆ·æ–°</button>
      </div>

      <div class="ctrlGroup">
        <label>
          <span>çªå‡ºID</span>
          <input id="hilite" type="number" min="0" max="511" step="1" placeholder="ç©º=ä¸çªå‡º" />
        </label>
      </div>


      <div class="ctrlGroup">
        <label>
          <span> è¿½æ±‚æ•ˆç‡ <-> è¿½æ±‚å…¬å¹³ </span>
          <input id="beta" type="range" min="0.00" max="2.00" step="0.05" value="0.50" />
          <span id="betaVal">0.50</span>
        </label>
      </div>
    </div>
  </div>

  <script>
    const N = 512;
    const EPS = 1e-12;

    const DARK2D = {
      paper_bgcolor: "#0f1620",
      plot_bgcolor: "#0f1620",
      font: { color: "#e5e7eb" },
      xaxis: { gridcolor: "#1f2a37", zerolinecolor: "#1f2a37", linecolor: "#1f2a37", tickfont: { color: "#e5e7eb" }, titlefont: { color: "#e5e7eb" } },
      yaxis: { gridcolor: "#1f2a37", zerolinecolor: "#1f2a37", linecolor: "#1f2a37", tickfont: { color: "#e5e7eb" }, titlefont: { color: "#e5e7eb" } },
    };

    const DARK3D = {
      paper_bgcolor: "#0f1620",
      plot_bgcolor: "#0f1620",
      font: { color: "#e5e7eb" },
      scene: {
        bgcolor: "#0f1620",
        xaxis: { gridcolor: "#1f2a37", zerolinecolor: "#1f2a37", color: "#e5e7eb", titlefont: { color: "#e5e7eb" } },
        yaxis: { gridcolor: "#1f2a37", zerolinecolor: "#1f2a37", color: "#e5e7eb", titlefont: { color: "#e5e7eb" } },
        zaxis: { gridcolor: "#1f2a37", zerolinecolor: "#1f2a37", color: "#e5e7eb", titlefont: { color: "#e5e7eb" } },
      }
    };


    // function hslColor(i, n) {
    //   const h = (i * 360.0 / n) % 360.0;
    //   return `hsl(${h.toFixed(1)},70%,50%)`;
    // }
    // const COLORS = Array.from({ length: N }, (_, i) => hslColor(i, N));

    function randn() { // Box-Muller
      let u = 0, v = 0;
      while (u === 0) u = Math.random();
      while (v === 0) v = Math.random();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    function argsort(arr) {
      return arr.map((v, i) => [v, i]).sort((a, b) => a[0] - b[0]).map(p => p[1]);
    }

    function stableSoftmax(x) {
      let m = -Infinity;
      for (const v of x) if (v > m) m = v;
      const ex = x.map(v => Math.exp(v - m));
      const s = ex.reduce((a, b) => a + b, 0) + EPS;
      return ex.map(v => v / s);
    }

    const clamp01 = x => x < 0 ? 0 : (x > 1 ? 1 : x);

    function hslToRgb01(h, s, l) { // h,s,l in [0,1]
      const hue2rgb = (p, q, t) => {
        if (t < 0) t += 1;
        if (t > 1) t -= 1;
        if (t < 1 / 6) return p + (q - p) * 6 * t;
        if (t < 1 / 2) return q;
        if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
        return p;
      };
      if (s === 0) return [l, l, l];
      const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      const p = 2 * l - q;
      return [
        hue2rgb(p, q, h + 1 / 3),
        hue2rgb(p, q, h),
        hue2rgb(p, q, h - 1 / 3),
      ];
    }

    function rgbaFromHsl(hDeg, sPct, lPct, a) {
      const h = ((hDeg % 360) + 360) % 360 / 360;
      const s = clamp01(sPct / 100);
      const l = clamp01(lPct / 100);
      const [r, g, b] = hslToRgb01(h, s, l).map(x => Math.round(x * 255));
      return `rgba(${r},${g},${b},${a})`;
    }

    function minMax(arr) {
      let mn = Infinity, mx = -Infinity;
      for (const v of arr) { if (v < mn) mn = v; if (v > mx) mx = v; }
      return [mn, mx];
    }

    function getHighlightId() { return hiliteCommitted; }

    // é¢œè‰²æ˜ å°„ï¼šH=id, S=rho(è¶Šé«˜è¶Šé¥±å’Œ), L=kappa(è¶Šé«˜è¶Šäº®)
    function buildColors(rho, kappa, alphaFn) {
      const [r0, r1] = minMax(rho);
      const [k0, k1] = minMax(kappa);
      const dr = (r1 - r0) + EPS;
      const dk = (k1 - k0) + EPS;

      const S_MIN = 50, S_MAX = 100;  // é¥±å’Œåº¦èŒƒå›´
      const L_MIN = 50, L_MAX = 100;  // äº®åº¦èŒƒå›´ï¼ˆæ›´ä½æ•ˆæ›´äº® => kappa è¶Šå¤§ L è¶Šå¤§ï¼‰

      const out = new Array(N);
      for (let i = 0; i < N; i++) {
        const h = i * 360 / N;
        const rn = clamp01((rho[i] - r0) / dr);
        const kn = clamp01((kappa[i] - k0) / dk);
        const s = S_MIN + rn * (S_MAX - S_MIN);
        const l = L_MIN + kn * (L_MAX - L_MIN);
        out[i] = rgbaFromHsl(h, s, l, alphaFn(i));
      }
      return out;
    }


    function sampleUniform(min, max) { return min + (max - min) * Math.random(); }
    function sampleNormalPos(mean, sd, minPos) { return Math.max(minPos, mean + sd * randn()); }
    function samplePareto(xmin, alpha) { // inverse transform
      const u = Math.random();
      return xmin * Math.pow(1.0 - u, -1.0 / alpha);
    }

    function genData(dist) {
      let V, L;
      if (dist === "uniform") {
        V = Array.from({ length: N }, _ => sampleUniform(1, 21));
        L = Array.from({ length: N }, _ => 1 + Math.floor(sampleUniform(0, 200)));
      } else if (dist === "normal") {
        V = Array.from({ length: N }, _ => sampleNormalPos(10, 3, 0.1));
        L = Array.from({ length: N }, _ => Math.max(1, Math.floor(sampleNormalPos(60, 20, 1))));
      } else { // powerlaw
        V = Array.from({ length: N }, _ => Math.min(1000, 8 * samplePareto(1, 1.6)));
        L = Array.from({ length: N }, _ => Math.max(1, Math.floor(Math.min(2000, 30 * samplePareto(1, 1.8)))));
      }
      return { V, L };
    }

    function computeMonopoly(V, beta) {
      const mu = V.reduce((a, b) => a + b, 0) / (V.length + EPS);
      const rho = V.map(v => v / (mu + EPS));
      const u = rho.map(r => beta * r);
      const w = stableSoftmax(u);
      const ord = argsort(V);
      return { mu, rho, w, ord };
    }

    function computeAGI(V, L, betaAGI) {
      const a = V.map((v, i) => v / (L[i] + EPS));
      const meanA = a.reduce((p, c) => p + c, 0) / (a.length + EPS);
      const kappa = a.map(x => meanA / (x + EPS));
      const u = kappa.map(k => betaAGI * (k - 1.0));
      const w = stableSoftmax(u);
      const ord = argsort(a);
      return { a, meanA, kappa, w, ord };
    }

    // state
    let beta = 0.50;
    let dist = "uniform";
    let { V, L } = genData(dist);
    let p7Camera = null;
    let p7UiRev = 1; // å¯é€‰ï¼šç”¨äºéšæœºåˆ·æ–°æ—¶é‡ç½®è§†è§’
    let hiliteCommitted = null; // åªæœ‰å›è½¦æ‰æ›´æ–°è¿™ä¸ª


    function renderAll() {
      const betaAGI = 2.0 - beta;
      const idx = Array.from({ length: N }, (_, i) => i);

      const M = computeMonopoly(V, beta);
      const A = computeAGI(V, L, betaAGI);

      const hi = getHighlightId();

      // ä¸åŒå›¾å±‚ç»™ä¸åŒâ€œåº•å™ªé€æ˜åº¦â€ï¼Œé¿å…å…¨å±å¤ªæš—/å¤ªåˆºçœ¼
      const alphaBar = i => hi == null ? 1.00 : (i === hi ? 1.00 : 0.05);
      const alpha2d = i => hi == null ? 1.00 : (i === hi ? 1.00 : 0.05);

      const C_BAR = buildColors(M.rho, A.kappa, alphaBar);
      const C_2D = buildColors(M.rho, A.kappa, alpha2d);
      const C_3D = buildColors(M.rho, A.kappa, _ => 1.00);


      // Precompute sorted helpers
      const ordV = M.ord, ordA = A.ord;
      const k = Array.from({ length: N }, (_, i) => i);

      const V_sorted = ordV.map(i => V[i]);
      const rho_sorted = ordV.map(i => M.rho[i]);
      const wM_sorted = ordV.map(i => M.w[i]);
      const colorsV = ordV.map(i => C_2D[i]);
      const idV = ordV.map(i => i);

      const a_sorted = ordA.map(i => A.a[i]);
      const k_sorted = ordA.map(i => A.kappa[i]);
      const wA_sorted = ordA.map(i => A.w[i]);
      const colorsA = ordA.map(i => C_2D[i]);
      const idA = ordA.map(i => i);

      // 1) äº§å€¼
      Plotly.react("p1", [{
        type: "bar",
        x: idx,
        y: V,
        marker: { color: C_BAR },
        hovertext: V.map((v, i) => `ä¸»ä½“ID=${i}<br>äº§å€¼=${v.toPrecision(6)}`),
        hoverinfo: "text",
        showlegend: false
      }], {
        ...DARK2D,
        margin: { l: 52, r: 12, t: 10, b: 42 },
        xaxis: { ...DARK2D.xaxis, title: "ä¸»ä½“ç¼–å·" },
        yaxis: { ...DARK2D.yaxis, title: "äº§å€¼" },
      }, { displayModeBar: false, responsive: true });

      // 2) é›‡ä½£äººæ•°
      Plotly.react("p2", [{
        type: "bar",
        x: idx,
        y: L,
        marker: { color: C_BAR },
        hovertext: L.map((v, i) => `ä¸»ä½“ID=${i}<br>é›‡ä½£äººæ•°=${v}`),
        hoverinfo: "text",
        showlegend: false
      }], {
        ...DARK2D,
        margin: { l: 52, r: 12, t: 10, b: 42 },
        xaxis: { ...DARK2D.xaxis, title: "ä¸»ä½“ç¼–å·" },
        yaxis: { ...DARK2D.yaxis, title: "é›‡ä½£äººæ•°" },
      }, { displayModeBar: false, responsive: true });

      // 3) å„æ–­ç¨‹åº¦ï¼ˆæŒ‰äº§å€¼æ’åºï¼‰
      Plotly.react("p3", [{
        type: "scatter",
        mode: "lines+markers",
        x: k,
        y: rho_sorted,
        line: { color: "rgba(229,231,235,0.35)" },
        marker: { color: colorsV, size: 7 },
        hovertext: rho_sorted.map((v, idx2) => `ä¸»ä½“ID=${idV[idx2]}<br>å„æ–­ç¨‹åº¦=${v.toPrecision(6)}<br>äº§å€¼(æ’åº)=${V_sorted[idx2].toPrecision(6)}`),
        hoverinfo: "text",
        showlegend: false
      }, {
        type: "scatter",
        mode: "lines",
        x: k,
        y: k.map(_ => 1.0),
        line: { color: "rgba(229,231,235,0.25)", dash: "dash" },
        hoverinfo: "skip",
        showlegend: false
      }], {
        ...DARK2D,
        margin: { l: 52, r: 12, t: 10, b: 42 },
        xaxis: { ...DARK2D.xaxis, title: "åæ¬¡ kï¼ˆæŒ‰äº§å€¼ä»å°åˆ°å¤§ï¼‰" },
        yaxis: { ...DARK2D.yaxis, title: "å„æ–­ç¨‹åº¦ï¼ˆç›¸å¯¹å¹³å‡ï¼‰" },
      }, { displayModeBar: false, responsive: true });

      // 4) ä½æ•ˆç¨‹åº¦ï¼ˆæŒ‰äººå‡äº§å€¼æ’åºï¼‰
      Plotly.react("p4", [{
        type: "scatter",
        mode: "lines+markers",
        x: k,
        y: k_sorted,
        line: { color: "rgba(229,231,235,0.35)" },
        marker: { color: colorsA, size: 7 },
        hovertext: k_sorted.map((v, idx2) => `ä¸»ä½“ID=${idA[idx2]}<br>ä½æ•ˆç¨‹åº¦=${v.toPrecision(6)}<br>äººå‡äº§å€¼(æ’åº)=${a_sorted[idx2].toPrecision(6)}`),
        hoverinfo: "text",
        showlegend: false
      }, {
        type: "scatter",
        mode: "lines",
        x: k,
        y: k.map(_ => 1.0),
        line: { color: "rgba(229,231,235,0.25)", dash: "dash" },
        hoverinfo: "skip",
        showlegend: false
      }], {
        ...DARK2D,
        margin: { l: 52, r: 12, t: 10, b: 42 },
        xaxis: { ...DARK2D.xaxis, title: "åæ¬¡ kï¼ˆæŒ‰äººå‡äº§å€¼ä»å°åˆ°å¤§ï¼‰" },
        yaxis: { ...DARK2D.yaxis, title: "ä½æ•ˆç¨‹åº¦ï¼ˆç›¸å¯¹å¹³å‡ï¼‰" },
      }, { displayModeBar: false, responsive: true });

      // 5) å„æ–­ç¨æƒé‡ï¼ˆæŒ‰äº§å€¼æ’åºï¼‰
      Plotly.react("p5", [{
        type: "scatter",
        mode: "lines+markers",
        x: k,
        y: wM_sorted,
        line: { color: "rgba(229,231,235,0.35)" },
        marker: { color: colorsV, size: 7 },
        hovertext: wM_sorted.map((v, idx2) => `ä¸»ä½“ID=${idV[idx2]}<br>å„æ–­ç¨æƒé‡=${v.toPrecision(6)}<br>å„æ–­ç¨‹åº¦=${rho_sorted[idx2].toPrecision(6)}`),
        hoverinfo: "text",
        showlegend: false
      }], {
        ...DARK2D,
        margin: { l: 52, r: 12, t: 10, b: 42 },
        xaxis: { ...DARK2D.xaxis, title: "åæ¬¡ kï¼ˆæŒ‰äº§å€¼ï¼‰" },
        yaxis: { ...DARK2D.yaxis, title: "å„æ–­ç¨æƒé‡ï¼ˆåŠ å’Œ=1ï¼‰" },
      }, { displayModeBar: false, responsive: true });

      // 6) ä½æ•ˆç¨æƒé‡ï¼ˆæŒ‰äººå‡äº§å€¼æ’åºï¼‰
      Plotly.react("p6", [{
        type: "scatter",
        mode: "lines+markers",
        x: k,
        y: wA_sorted,
        line: { color: "rgba(229,231,235,0.35)" },
        marker: { color: colorsA, size: 7 },
        hovertext: wA_sorted.map((v, idx2) => `ä¸»ä½“ID=${idA[idx2]}<br>ä½æ•ˆç¨æƒé‡=${v.toPrecision(6)}<br>ä½æ•ˆç¨‹åº¦=${k_sorted[idx2].toPrecision(6)}`),
        hoverinfo: "text",
        showlegend: false
      }], {
        ...DARK2D,
        margin: { l: 52, r: 12, t: 10, b: 42 },
        xaxis: { ...DARK2D.xaxis, title: "åæ¬¡ kï¼ˆæŒ‰äººå‡äº§å€¼ï¼‰" },
        yaxis: { ...DARK2D.yaxis, title: "ä½æ•ˆç¨æƒé‡ï¼ˆåŠ å’Œ=1ï¼‰" },
      }, { displayModeBar: false, responsive: true });

      // 7) ä¸‰ç»´ç»¼åˆç¨ç‡ï¼št_i = normalize(wM + wA)
      const raw = idx.map(i => M.w[i] + A.w[i]);
      const denom = raw.reduce((a, b) => a + b, 0) + EPS;
      const t = raw.map(v => v / denom);

      const gd7 = document.getElementById("p7");
      if (gd7 && gd7._fullLayout?.scene?.camera) p7Camera = gd7._fullLayout.scene.camera;

      const xs = idx.map(i => M.rho[i]);
      const ys = idx.map(i => A.kappa[i]);
      const zs = t;

      const mkTrace = (keep, opacity, sizeBoost) => {
        const X = [], Y = [], Z = [], C = [], H = [];
        for (let i = 0; i < N; i++) if (keep(i)) {
          X.push(xs[i]); Y.push(ys[i]); Z.push(zs[i]); C.push(C_3D[i]); H.push(i);
        }
        return {
          type: "scatter3d", mode: "markers", x: X, y: Y, z: Z,
          opacity,
          marker: { size: 4 + (sizeBoost || 0), color: C },
          hovertext: H.map(i =>
            `ä¸»ä½“ID=${i}` +
            `<br>äº§å€¼=${V[i].toPrecision(6)}` +
            `<br>é›‡ä½£äººæ•°=${L[i]}` +
            `<br>å„æ–­ç¨‹åº¦=${M.rho[i].toPrecision(6)}` +
            `<br>ä½æ•ˆç¨‹åº¦=${A.kappa[i].toPrecision(6)}` +
            `<br>å„æ–­ç¨æƒé‡=${M.w[i].toPrecision(6)}` +
            `<br>ä½æ•ˆç¨æƒé‡=${A.w[i].toPrecision(6)}` +
            `<br>ç»¼åˆç¨ç‡=${t[i].toPrecision(6)}`
          ),
          hoverinfo: "text",
          showlegend: false
        };
      };

      const traces = (hi == null)
        ? [mkTrace(_ => true, 1.0, 0)]
        : [mkTrace(i => i !== hi, 0.05, 0), mkTrace(i => i === hi, 1.0, 2)];

      Plotly.react("p7", traces, {
        ...DARK3D,
        margin: { l: 0, r: 0, t: 10, b: 0 },
        uirevision: p7UiRev,
        scene: {
          ...DARK3D.scene,
          uirevision: p7UiRev,
          camera: p7Camera || undefined,
          xaxis: { ...DARK3D.scene.xaxis, title: "å„æ–­ç¨‹åº¦" },
          yaxis: { ...DARK3D.scene.yaxis, title: "ä½æ•ˆç¨‹åº¦" },
          zaxis: { ...DARK3D.scene.zaxis, title: "ç»¼åˆç¨ç‡ï¼ˆå½’ä¸€åŒ–ï¼‰" },
        }
      }, { displayModeBar: true, responsive: true });
    }

    // controls
    const betaEl = document.getElementById("beta");
    const betaValEl = document.getElementById("betaVal");
    const distEl = document.getElementById("dist");
    const randBtn = document.getElementById("randBtn");
    const hiliteEl = document.getElementById("hilite");

    betaEl.addEventListener("input", (e) => {
      beta = parseFloat(e.target.value);
      betaValEl.textContent = beta.toFixed(2);
      renderAll();
    });

    hiliteEl?.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const s = (hiliteEl.value ?? "").toString().trim();
      const id = s === "" ? null : Number.parseInt(s, 10);
      hiliteCommitted = (id != null && Number.isFinite(id) && id >= 0 && id < N) ? id : null;
      renderAll();
    });


    distEl.addEventListener("change", (e) => { dist = e.target.value; });

    randBtn.addEventListener("click", () => {
      ({ V, L } = genData(dist));
      renderAll();
    });

    betaValEl.textContent = beta.toFixed(2);
    renderAll();
  </script>
</body>

</html>